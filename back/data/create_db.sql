BEGIN;

DROP TABLE IF EXISTS "category", "list", "link", "list_has_category";

CREATE TABLE "category"(
    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" TEXT NOT NULL,
    "created_at" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    "updated_at" TIMESTAMPTZ
);

CREATE TABLE "list"(

    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" TEXT NOT NULL,
    "position" INTEGER NOT NULL DEFAULT 0,
    "created_at" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    "updated_at" TIMESTAMPTZ
);

CREATE TABLE "link"(
    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "url" TEXT NOT NULL,
    "position" INTEGER NOT NULL DEFAULT 0,
    "created_at" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    "updated_at" TIMESTAMPTZ,
    "list_id" INTEGER NOT NULL REFERENCES "list"("id") ON DELETE CASCADE
);


CREATE TABLE "list_has_category"(
    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "list_id" INTEGER NOT NULL REFERENCES "list" ON DELETE CASCADE,
    "category_id" INTEGER NOT NULL REFERENCES "category" ON DELETE CASCADE,
    "created_at" TIMESTAMPTZ NOT NULL DEFAULT NOW()
);


INSERT INTO "category" ("id", "name")
VALUES
(1, 'Musique'),
(2, 'Vidéo'),
(3, 'Concert');

INSERT INTO "list" ("id", "name", "position")
VALUES
(1, 'À écouter', 1),
(2, 'À réécouter', 0),
(3, 'À regarder', 0),
(4, 'À acheter', 0)
;

INSERT INTO "link" ("id", "url", "list_id", "position")
VALUES
(1, 'https://deezer.page.link/svcDETuGbBHyeAFG8', 1, 0),
(2, 'https://deezer.page.link/xTZroX7xSB3bFKph7', 2, 0),
(3, 'https://www.youtube.com/watch?v=wa-E3WlQcSE', 3, 0),
(4, 'https://www.sallepleyel.com/concerts-spectacles/metal-hard-rock/opeth_e734', 4, 0);

INSERT INTO "list_has_category" ("list_id", "category_id")
VALUES
(1, 1),
(2, 1),
(3, 2),
(4, 3);

-- Ces 3 requêtes permettent de faire démarré le compteur d'incrémentation automatique des tables à partir du dernier id présent dans les enregistrements
SELECT setval('list_id_seq', (SELECT MAX(id) from "list"));
SELECT setval('link_id_seq', (SELECT MAX(id) from "link"));
SELECT setval('category_id_seq', (SELECT MAX(id) from "category"));


COMMIT;